---
title: "Sedative Heat Map NB"
author: "PO Couture"
format: html
editor: visual
---

## Heat Map Code

## Loading in the Code
```{r}
library(readxl)
Age_x_HCC_Sheet <- read_excel("Age x HCC Sheet.xlsx")
glimpse(Age_x_HCC_Sheet)
View(Age_x_HCC_Sheet)

Age_x_HCC_Sheet <- Age_x_HCC_Sheet[, !names(Age_x_HCC_Sheet) %in% c("...8", "...9")]
```

## Chronic Use % by HCC and Sex

```{r}
#|label: Complete Code Used for Analysis

# ----------------------------------------------------------
# LOAD PACKAGES
# ----------------------------------------------------------
library(dplyr)
library(sf)
library(ggplot2)
library(ggrepel)
library(ragg)
library(lwgeom)  

# ----------------------------------------------------------
# SUMMARIZE DATA
# ----------------------------------------------------------
# --- Summaries ---
men_summary <- Age_x_HCC_Sheet %>%
  group_by(M_HCC) %>%
  summarise(
    Sex = "Men",
    Chronic_Use = sum(`M_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(M_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = M_HCC)

women_summary <- Age_x_HCC_Sheet %>%
  group_by(W_HCC) %>%
  summarise(
    Sex = "Women",
    Chronic_Use = sum(`W_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(W_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = W_HCC)

df_combined <- bind_rows(men_summary, women_summary)

total_summary <- df_combined %>%
  group_by(HCC) %>%
  summarise(
    Sex = "Total",
    Chronic_Use = sum(Chronic_Use, na.rm = TRUE),
    Population = sum(Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  )

df_hcc_final <- bind_rows(df_combined, total_summary) %>%
  mutate(HCC = as.numeric(as.character(HCC)))

# --- Load shapefiles ---
hcc <- st_read("https://gnb.socrata.com/api/geospatial/sdyn-7de6?method=export&format=GeoJSON", quiet = TRUE) %>%
  st_make_valid() %>%
  mutate(com = as.numeric(com))

zones <- st_read("https://gnb.socrata.com/api/geospatial/x8mg-22ju?method=export&format=GeoJSON", quiet = TRUE) %>%
  st_make_valid()

hcc_map <- hcc %>%
  left_join(df_hcc_final, by = c("com" = "HCC"))

zones_union <- st_union(st_make_valid(zones))

# --- Plot function ---
plot_hcc_final <- function(data, sex_label) {
  dat_sex <- subset(data, Sex == sex_label)
  
  # Get label positions - use st_point_on_surface to ensure points are inside polygons
  centroids <- st_point_on_surface(dat_sex)
  coords <- as.data.frame(st_coordinates(centroids))
  centroids <- cbind(dat_sex, coords)
  
  # Define which HCCs get arrows pointing outside (removed 5, 7, 8, 11, 14.1, 14.2)
  arrow_hccs <- c(6, 14.3, 22.1)
  
  # Base label positions
  centroids <- centroids %>%
    mutate(
      xend = X,
      yend = Y,
      label_x = X,
      label_y = Y
    )
  
  # Custom arrow directions and distances for each HCC with arrows
  centroids <- centroids %>%
    mutate(
      # Northeast cluster - only 6 gets arrow
      xend = case_when(
        com == 6 ~ X + 0.75,
        # East coast - only 14.3 gets arrow
        com == 14.3 ~ X + 0.35,
        # Southeast
        com == 22.1 ~ X + 2.2,
        TRUE ~ X
      ),
      yend = case_when(
        com == 6 ~ Y + 0.6,
        com == 14.3 ~ Y - 0.35,
        com == 22.1 ~ Y - 0.7,
        TRUE ~ Y
      ),
      label_x = case_when(
        com == 6 ~ X + 0.82,
        com == 14.3 ~ X + 0.42,
        com == 22.1 ~ X + 2.3,
        TRUE ~ X
      ),
      label_y = case_when(
        com == 6 ~ Y + 0.67,
        com == 14.3 ~ Y - 0.42,
        com == 22.1 ~ Y - 0.77,
        TRUE ~ Y
      )
    )
  
  ggplot() +
    geom_sf(data = zones_union, fill = NA, color = "grey40", linewidth = 0.8) +
    geom_sf(data = dat_sex, aes(fill = Chronic_Pct), color = "white", linewidth = 0.4) +
    
    # Add arrows for selected HCCs only
    geom_segment(
      data = subset(centroids, com %in% arrow_hccs),
      aes(x = X, y = Y, xend = xend, yend = yend),
      arrow = arrow(length = unit(0.15, "inches")),
      color = "black",
      linewidth = 0.3
    ) +
    
    # Add white label background
    geom_label(
      data = centroids,
      aes(x = label_x, y = label_y, label = paste0(round(Chronic_Pct, 1), "%")),
      color = "black",
      fill = "white",
      size = 1.9,
      fontface = "bold",
      label.padding = unit(0.1, "lines"),
      label.size = 0
    ) +
    
    scale_fill_gradient(
      low = "#e6d3fa", high = "#3f007d",
      name = "% Chronic Use", na.value = "grey90"
    ) +
    
    labs(
      title = paste("Chronic BZRA Use by Health Council (HCC) –", sex_label),
      subtitle = "Darker = Higher % Chronic Use",
      caption = "Data source: NBHC Health Councils"
    ) +
    
    theme_void(base_size = 14) +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5, color = "black"),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "black"),
      plot.caption = element_text(size = 10, hjust = 1, color = "black")
    )
}

# --- Export ---
map_men   <- plot_hcc_final(hcc_map, "Men")
map_women <- plot_hcc_final(hcc_map, "Women")
map_total <- plot_hcc_final(hcc_map, "Total")

agg_png("HCC_Map_Men.png", width = 4000, height = 3200, res = 600);   print(map_men);   dev.off()
agg_png("HCC_Map_Women.png", width = 4000, height = 3200, res = 600); print(map_women); dev.off()
agg_png("HCC_Map_Total.png", width = 4000, height = 3200, res = 600); print(map_total); dev.off()
```

## Chronic Use % for males 65-69 and Females 85+

```{r}
#|label: Males 65-69 and Females 85+

# ----------------------------------------------------------
# AGE-SPECIFIC MAPS: Males 65-69 and Females 85+
# ----------------------------------------------------------

# --- Males 65-69 Summary ---
men_65_69_summary <- Age_x_HCC_Sheet %>%
  filter(M_Age_Group == "65-69") %>%
  group_by(M_HCC) %>%
  summarise(
    Sex = "Men 65-69",
    Chronic_Use = sum(`M_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(M_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = M_HCC) %>%
  mutate(HCC = as.numeric(as.character(HCC)))

# --- Females 85+ Summary ---
women_85plus_summary <- Age_x_HCC_Sheet %>%
  filter(W_Age_Group == "85+") %>%
  group_by(W_HCC) %>%
  summarise(
    Sex = "Women 85+",
    Chronic_Use = sum(`W_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(W_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = W_HCC) %>%
  mutate(HCC = as.numeric(as.character(HCC)))

# --- Join to spatial data ---
hcc_map_men_65_69 <- hcc %>%
  left_join(men_65_69_summary, by = c("com" = "HCC"))

hcc_map_women_85plus <- hcc %>%
  left_join(women_85plus_summary, by = c("com" = "HCC"))

# --- Generate maps ---
map_men_65_69 <- plot_hcc_final(hcc_map_men_65_69, "Men 65-69")
map_women_85plus <- plot_hcc_final(hcc_map_women_85plus, "Women 85+")

# --- Export ---
agg_png("HCC_Map_Men_65_69.png", width = 4000, height = 3200, res = 600)
print(map_men_65_69)
dev.off()

agg_png("HCC_Map_Women_85plus.png", width = 4000, height = 3200, res = 600)
print(map_women_85plus)
dev.off()

```
## National Map

```{r}
#| label: Map of Canada Use
# Install and load required packages
# install.packages(c("ggplot2", "dplyr", "sf"))

library(ggplot2)
library(dplyr)
library(sf)

# Data from the image
province_data <- data.frame(
  province = c("BC", "AB", "SK", "MB", "ON", "NB", "PEI", "NS", "NL"),
  percentage = c(6.7, 9.9, 5.4, 10.7, 7.2, 22.6, 7.8, 14.1, 16.8),
  PRENAME = c("British Columbia", "Alberta", "Saskatchewan", "Manitoba",
              "Ontario", "New Brunswick", "Prince Edward Island", 
              "Nova Scotia", "Newfoundland and Labrador"),
  stringsAsFactors = FALSE
)

# Define color categories based on your specifications
province_data <- province_data %>%
  mutate(
    category = case_when(
      percentage >= 0 & percentage < 5 ~ "0-4.9",
      percentage >= 5 & percentage < 7 ~ "5-6.9",
      percentage >= 7 & percentage < 9 ~ "7-8.9",
      percentage >= 9 & percentage < 11 ~ "9-10.9",
      percentage >= 13 & percentage < 15 ~ "13-14.9",
      percentage >= 15 & percentage < 17 ~ "15-16.9",
      percentage >= 21 & percentage < 23 ~ "21-22.9",
      TRUE ~ "Other"
    ),
    category = factor(category, levels = c("0-4.9", "5-6.9", "7-8.9", 
                                           "9-10.9", "13-14.9", "15-16.9", 
                                           "21-22.9"))
  )

# Download Canada provinces shapefile from Statistics Canada
# This is a direct download from a reliable government source
temp_zip <- tempfile(fileext = ".zip")
temp_dir <- tempdir()

download.file(
  "https://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/lpr_000b16a_e.zip",
  destfile = temp_zip,
  mode = "wb"
)

unzip(temp_zip, exdir = temp_dir)

# Read the shapefile
canada_sf <- st_read(file.path(temp_dir, "lpr_000b16a_e.shp"), quiet = TRUE)

# Filter to only provinces (exclude territories for cleaner look if desired)
# PRUID codes: 10=NL, 11=PE, 12=NS, 13=NB, 24=QC, 35=ON, 46=MB, 47=SK, 48=AB, 59=BC
canada_provinces <- canada_sf %>%
  filter(PRUID %in% c("10", "11", "12", "13", "24", "35", "46", "47", "48", "59"))

# Merge with our data
canada_map <- canada_provinces %>%
  left_join(province_data, by = "PRENAME")

# Calculate centroids for labels
centroids <- st_centroid(canada_map) %>%
  st_coordinates() %>%
  as.data.frame()

canada_map <- cbind(canada_map, centroids)

# Adjust label positions for Maritime provinces to avoid overlap
canada_map <- canada_map %>%
  mutate(
    label_x = case_when(
      province == "NB" ~ X + 1.5,  # Move NB label to the right
      province == "NS" ~ X + 2.0,  # Move NS label further right
      province == "PEI" ~ X - 0.5,  # Move PEI label slightly left
      province == "NL" ~ X - 10.0,
      TRUE ~ X
    ),
    label_y = case_when(
      province == "NB" ~ Y + 0.5,  # Move NB label up
      province == "NS" ~ Y - 10.0,  # Move NS label down
      province == "PEI" ~ Y + 5.0,  # Move PEI label up
      TRUE ~ Y
    )
  )

# Define colors based on your specifications
color_scale <- c(
  "0-4.9" = "#00FF00",      # bright green
  "5-6.9" = "#66CC66",      # semi-solid green
  "7-8.9" = "#99DD99",      # semi-transparent green
  "9-10.9" = "#D8BFD8",     # lavender purple (5-10%)
  "13-14.9" = "#C8A8D8",    # lavender purple (10-15%)
  "15-16.9" = "#B892C8",    # lavender purple (15-20%)
  "21-22.9" = "#A87CB8"     # lavender purple (20-25%)
)

# Create the map
ggplot(data = canada_map) +
  geom_sf(aes(fill = category), color = "white", size = 0.5) +
  scale_fill_manual(
    values = color_scale,
    na.value = "grey90",
    name = "Chronic Use (%)",
    labels = c("0-4.9", "5-6.9 (SK, BC)", "7-8.9 (ON, PEI)", 
               "9-10.9 (AB, MB)", "13-14.9 (NS)", "15-16.9 (NL)", 
               "21-22.9 (NB)"),
    drop = FALSE
  ) +
  # Add province labels with percentages
  geom_text(aes(x = label_x, y = label_y, label = ifelse(!is.na(percentage), 
                                              paste0(province, "\n", percentage, "%"), 
                                              "")),
            size = 3.5, fontface = "bold", color = "black") +
  labs(
    title = "Chronic Use of 'Sleeping Pills' in Canada",
    subtitle = "2020/21: ≥65 y.o. sedative-hypnotic chronic use (%)",
    caption = "Source: CIHI, Overuse of Tests and Treatments in Canada Nov 2022"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    plot.caption = element_text(hjust = 0.5, size = 9, color = "grey50"),
    legend.position = "right",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 9),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

# Optional: Save the plot
ggsave("canada_sleeping_pills_heatmap.png", width = 14, height = 10, dpi = 300)

# Clean up temporary files
unlink(temp_zip)
unlink(file.path(temp_dir, "lpr_000b16a_e.*"))
```

