---
title: "Sedative Heat Map NB"
author: "PO Couture"
format: html
editor: visual
---

## Heat Map Code

## Loading in the Code
```{r}
library(readxl)
Age_x_HCC_Sheet <- read_excel("Age x HCC Sheet.xlsx")
glimpse(Age_x_HCC_Sheet)
View(Age_x_HCC_Sheet)

Age_x_HCC_Sheet <- Age_x_HCC_Sheet[, !names(Age_x_HCC_Sheet) %in% c("...8", "...9")]
```

## Chronic Use % by HCC and Sex

```{r}
#|label: Complete Code Used for Analysis

# ----------------------------------------------------------
# LOAD PACKAGES
# ----------------------------------------------------------
library(dplyr)
library(sf)
library(ggplot2)
library(ragg)
library(lwgeom)

# ----------------------------------------------------------
# UPDATED PLOT FUNCTION: keep HCC 11 original placement,
# move HCC 14.1 down & right relative to its centroid.
# Only arrows for: 6, 8, 14.3, 22.1
# ----------------------------------------------------------
plot_hcc_final <- function(data, sex_label) {
  dat_sex <- subset(data, Sex == sex_label)
  
  # Get "inside polygon" points
  centroids <- st_point_on_surface(dat_sex)
  coords <- as.data.frame(st_coordinates(centroids))
  centroids <- cbind(dat_sex, coords)
  
  # HCCs that should have arrows
  arrow_hccs <- c(6, 8, 14.3, 22.1)
  
  # Base: no movement
  centroids <- centroids %>%
    mutate(
      xend = X,
      yend = Y,
      label_x = X,
      label_y = Y
    )
  
  # Apply adjustments:
  centroids <- centroids %>%
    mutate(
      # arrow end positions only for selected HCCs
      xend = case_when(
        com == 6   ~ X + 0.75,
        com == 8   ~ X + 0.85,
        com == 14.3~ X + 0.35,
        com == 22.1~ X + 2.2,
        TRUE       ~ X
      ),
      yend = case_when(
        com == 6    ~ Y + 0.6,
        com == 8    ~ Y + 0.2,
        com == 14.3 ~ Y - 0.35,
        com == 22.1 ~ Y - 0.7,
        TRUE        ~ Y
      ),
      # label positions:
      # - KEEP HCC 11 at original centroid (no change)
      # - MOVE HCC 14.1 down & right from original: +0.15 x, -0.15 y
      label_x = case_when(
        com == 6    ~ X + 0.82,
        com == 8    ~ X + 0.92,
        com == 14.3 ~ X + 0.42,
        com == 22.1 ~ X + 2.3,
        com == 14.1 ~ X + 0.15,   # moved right
        TRUE        ~ X           # includes com == 11 (keeps original)
      ),
      label_y = case_when(
        com == 6    ~ Y + 0.67,
        com == 8    ~ Y + 0.27,
        com == 14.3 ~ Y - 0.42,
        com == 22.1 ~ Y - 0.77,
        com == 14.1 ~ Y - 0.15,   # moved down
        TRUE        ~ Y
      )
    )
  
  # Build plot
  ggplot() +
    # zone outlines
    geom_sf(data = zones_union, fill = NA, color = "grey40", linewidth = 0.8) +
    # HCC fill
    geom_sf(data = dat_sex, aes(fill = Chronic_Pct), color = "white", linewidth = 0.4) +
    
    # arrows only for specified HCCs
    geom_segment(
      data = subset(centroids, com %in% arrow_hccs),
      aes(x = X, y = Y, xend = xend, yend = yend),
      arrow = arrow(length = unit(0.15, "inches")), # small arrowhead; change to NULL for plain line
      color = "black",
      linewidth = 0.3
    ) +
    
    # labels: white background for readability
    geom_label(
      data = centroids,
      aes(x = label_x, y = label_y, label = paste0(round(Chronic_Pct, 1), "%")),
      color = "black",
      fill = "white",
      size = 1.8,
      fontface = "bold",
      label.padding = unit(0.08, "lines"),
      label.size = 0
    ) +
    
    scale_fill_gradient(
      low = "#e6d3fa", high = "#3f007d",
      name = "% Chronic Use", na.value = "grey90"
    ) +
    
    labs(
      title = paste("Chronic BZRA Use by Health Council (HCC) â€“", sex_label),
      subtitle = "Darker = Higher % Chronic Use",
      caption = "Data source: NBHC Health Councils"
    ) +
    
    theme_void(base_size = 14) +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5, color = "black"),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "black"),
      plot.caption = element_text(size = 10, hjust = 1, color = "black")
    )
}

# ----------------------------------------------------------
# CREATE & EXPORT (men/women/total)
# ----------------------------------------------------------
map_men   <- plot_hcc_final(hcc_map, "Men")
map_women <- plot_hcc_final(hcc_map, "Women")
map_total <- plot_hcc_final(hcc_map, "Total")

agg_png("HCC_Map_Men.png", width = 4000, height = 3200, res = 600);   print(map_men);   dev.off()
agg_png("HCC_Map_Women.png", width = 4000, height = 3200, res = 600); print(map_women); dev.off()
agg_png("HCC_Map_Total.png", width = 4000, height = 3200, res = 600); print(map_total); dev.off()
```