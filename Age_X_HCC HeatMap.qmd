---
title: "Sedative Heat Map NB"
author: "PO Couture"
format: html
editor: visual
---

## Heat Map Code

## Loading in the Code
```{r}
library(readxl)
Age_x_HCC_Sheet <- read_excel("Age x HCC Sheet.xlsx")
glimpse(Age_x_HCC_Sheet)
View(Age_x_HCC_Sheet)

Age_x_HCC_Sheet <- Age_x_HCC_Sheet[, !names(Age_x_HCC_Sheet) %in% c("...8", "...9")]
```

## Chronic Use % by HCC and Sex

```{r}
#|label: Complete Code Used for Analysis

# ----------------------------------------------------------
# LOAD PACKAGES
# ----------------------------------------------------------
library(dplyr)
library(sf)
library(ggplot2)
library(ggrepel)
library(ragg)
library(lwgeom)  

# ----------------------------------------------------------
# CREATE OUTPUT FOLDER
# ----------------------------------------------------------
output_dir <- "FINAL MAPS"
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
  message("✅ Created folder: ", output_dir)
} else {
  message("✅ Folder already exists: ", output_dir)
}

# ----------------------------------------------------------
# CONSISTENT LEGEND LIMITS
# ----------------------------------------------------------
# Set the same scale for all HCC and Health Region maps
SCALE_MIN <- 0
SCALE_MAX <- 60

# ----------------------------------------------------------
# SUMMARIZE DATA
# ----------------------------------------------------------
# --- Summaries ---
men_summary <- Age_x_HCC_Sheet %>%
  group_by(M_HCC) %>%
  summarise(
    Sex = "Men",
    Chronic_Use = sum(`M_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(M_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = M_HCC)

women_summary <- Age_x_HCC_Sheet %>%
  group_by(W_HCC) %>%
  summarise(
    Sex = "Women",
    Chronic_Use = sum(`W_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(W_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = W_HCC)

df_combined <- bind_rows(men_summary, women_summary)

total_summary <- df_combined %>%
  group_by(HCC) %>%
  summarise(
    Sex = "Total",
    Chronic_Use = sum(Chronic_Use, na.rm = TRUE),
    Population = sum(Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  )

df_hcc_final <- bind_rows(df_combined, total_summary) %>%
  mutate(HCC = as.numeric(as.character(HCC)))

# --- Load shapefiles ---
hcc <- st_read("https://gnb.socrata.com/api/geospatial/sdyn-7de6?method=export&format=GeoJSON", quiet = TRUE) %>%
  st_make_valid() %>%
  mutate(com = as.numeric(com))

zones <- st_read("https://gnb.socrata.com/api/geospatial/x8mg-22ju?method=export&format=GeoJSON", quiet = TRUE) %>%
  st_make_valid()

hcc_map <- hcc %>%
  left_join(df_hcc_final, by = c("com" = "HCC"))

zones_union <- st_union(st_make_valid(zones))

# --- Plot function ---
plot_hcc_final <- function(data, sex_label) {
  dat_sex <- subset(data, Sex == sex_label)
  
  # Get label positions - use st_point_on_surface to ensure points are inside polygons
  centroids <- st_point_on_surface(dat_sex)
  coords <- as.data.frame(st_coordinates(centroids))
  centroids <- cbind(dat_sex, coords)
  
  # Define which HCCs get arrows pointing outside (removed 5, 7, 8, 11, 14.1, 14.2)
  arrow_hccs <- c(6, 14.3, 22.1)
  
  # Base label positions
  centroids <- centroids %>%
    mutate(
      xend = X,
      yend = Y,
      label_x = X,
      label_y = Y
    )
  
  # Custom arrow directions and distances for each HCC with arrows
  centroids <- centroids %>%
    mutate(
      # Northeast cluster - only 6 gets arrow
      xend = case_when(
        com == 6 ~ X + 0.75,
        # East coast - only 14.3 gets arrow
        com == 14.3 ~ X + 0.35,
        # Southeast
        com == 22.1 ~ X + 2.2,
        TRUE ~ X
      ),
      yend = case_when(
        com == 6 ~ Y + 0.6,
        com == 14.3 ~ Y - 0.35,
        com == 22.1 ~ Y - 0.7,
        TRUE ~ Y
      ),
      label_x = case_when(
        com == 6 ~ X + 0.82,
        com == 14.3 ~ X + 0.42,
        com == 22.1 ~ X + 2.3,
        TRUE ~ X
      ),
      label_y = case_when(
        com == 6 ~ Y + 0.67,
        com == 14.3 ~ Y - 0.42,
        com == 22.1 ~ Y - 0.77,
        TRUE ~ Y
      )
    )
  
  ggplot() +
    geom_sf(data = zones_union, fill = NA, color = "grey40", linewidth = 0.8) +
    geom_sf(data = dat_sex, aes(fill = Chronic_Pct), color = "white", linewidth = 0.4) +
    
    # Add arrows for selected HCCs only
    geom_segment(
      data = subset(centroids, com %in% arrow_hccs),
      aes(x = X, y = Y, xend = xend, yend = yend),
      arrow = arrow(length = unit(0.15, "inches")),
      color = "black",
      linewidth = 0.3
    ) +
    
    # Add white label background
    geom_label(
      data = centroids,
      aes(x = label_x, y = label_y, label = paste0(round(Chronic_Pct, 1), "%")),
      color = "black",
      fill = "white",
      size = 1.9,
      fontface = "bold",
      label.padding = unit(0.1, "lines"),
      label.size = 0
    ) +
    
    scale_fill_gradient(
      low = "#e6d3fa", high = "#3f007d",
      limits = c(SCALE_MIN, SCALE_MAX),
      name = "% Chronic Use", na.value = "grey90"
    ) +
    
    labs(
      title = paste("Chronic BSH Use by Health Council (HCC) –", sex_label),
      subtitle = "Darker = Higher % Chronic Use",
      caption = NULL
    ) +
    
    theme_void(base_size = 14) +
    theme(
      legend.position = "none",
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5, color = "black"),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "black"),
      plot.margin = margin(5, 5, 30, 5)
    ) +
    
    # Add caption as annotation to ensure it's centered and visible
    annotate("text", x = Inf, y = -Inf, 
             label = "BSHs include BZRAs (benzodiazepines and z-drugs), trazodone, and low-dose quetiapine",
             hjust = 0.5, vjust = -0.5, size = 3, color = "black")
}

# --- Export ---
map_men   <- plot_hcc_final(hcc_map, "Men")
map_women <- plot_hcc_final(hcc_map, "Women")
map_total <- plot_hcc_final(hcc_map, "Total")

agg_png(file.path(output_dir, "HCC_Map_Men.png"), width = 4000, height = 3200, res = 600)
print(map_men)
dev.off()
message("✅ Saved: HCC_Map_Men.png")

agg_png(file.path(output_dir, "HCC_Map_Women.png"), width = 4000, height = 3200, res = 600)
print(map_women)
dev.off()
message("✅ Saved: HCC_Map_Women.png")

agg_png(file.path(output_dir, "HCC_Map_Total.png"), width = 4000, height = 3200, res = 600)
print(map_total)
dev.off()
message("✅ Saved: HCC_Map_Total.png")
```

## Chronic Use % for males 65-69 and Females 85+

```{r}
#|label: Males 65-69 and Females 85+

# ----------------------------------------------------------
# AGE-SPECIFIC MAPS: Males 65-69 and Females 85+
# ----------------------------------------------------------

# --- Males 65-69 Summary ---
men_65_69_summary <- Age_x_HCC_Sheet %>%
  filter(M_Age_Group == "65-69") %>%
  group_by(M_HCC) %>%
  summarise(
    Sex = "Men 65-69",
    Chronic_Use = sum(`M_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(M_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = M_HCC) %>%
  mutate(HCC = as.numeric(as.character(HCC)))

# --- Females 85+ Summary ---
women_85plus_summary <- Age_x_HCC_Sheet %>%
  filter(W_Age_Group == "85+") %>%
  group_by(W_HCC) %>%
  summarise(
    Sex = "Women 85+",
    Chronic_Use = sum(`W_Chronic_Use(total)`, na.rm = TRUE),
    Population = sum(W_Estimated_Total_Population, na.rm = TRUE),
    Chronic_Pct = 100 * Chronic_Use / Population,
    .groups = "drop"
  ) %>%
  rename(HCC = W_HCC) %>%
  mutate(HCC = as.numeric(as.character(HCC)))

# --- Join to spatial data ---
hcc_map_men_65_69 <- hcc %>%
  left_join(men_65_69_summary, by = c("com" = "HCC"))

hcc_map_women_85plus <- hcc %>%
  left_join(women_85plus_summary, by = c("com" = "HCC"))

# --- Generate maps ---
map_men_65_69 <- plot_hcc_final(hcc_map_men_65_69, "Men 65-69")
map_women_85plus <- plot_hcc_final(hcc_map_women_85plus, "Women 85+")

# --- Export ---
agg_png(file.path(output_dir, "HCC_Map_Men_65_69.png"), width = 4000, height = 3200, res = 600)
print(map_men_65_69)
dev.off()

agg_png(file.path(output_dir, "HCC_Map_Women_85plus.png"), width = 4000, height = 3200, res = 600)
print(map_women_85plus)
dev.off()

```
## National Map

```{r}
#| label: Map of Canada Use
library(ggplot2)
library(dplyr)
library(sf)
library(here)

# ---- Data ----
province_data <- data.frame(
  province = c("BC", "AB", "SK", "MB", "ON", "NB", "PEI", "NS", "NL"),
  percentage = c(6.7, 9.9, 5.4, 10.7, 7.2, 22.6, 7.8, 14.1, 16.8),
  PRENAME = c("British Columbia", "Alberta", "Saskatchewan", "Manitoba",
              "Ontario", "New Brunswick", "Prince Edward Island", 
              "Nova Scotia", "Newfoundland and Labrador"),
  stringsAsFactors = FALSE
)

# ---- Categorize percentages ----
province_data <- province_data %>%
  mutate(
    category = case_when(
      percentage >= 0 & percentage < 5 ~ "0-4.9",
      percentage >= 5 & percentage < 7 ~ "5-6.9",
      percentage >= 7 & percentage < 9 ~ "7-8.9",
      percentage >= 9 & percentage < 11 ~ "9-10.9",
      percentage >= 13 & percentage < 15 ~ "13-14.9",
      percentage >= 15 & percentage < 17 ~ "15-16.9",
      percentage >= 21 & percentage < 23 ~ "21-22.9",
      TRUE ~ "Other"
    ),
    category = factor(category, levels = c("0-4.9", "5-6.9", "7-8.9", 
                                           "9-10.9", "13-14.9", "15-16.9", 
                                           "21-22.9"))
  )

# ---- Download Canada shapefile ----
temp_zip <- tempfile(fileext = ".zip")
temp_dir <- tempdir()

download.file(
  "https://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/lpr_000b16a_e.zip",
  destfile = temp_zip,
  mode = "wb"
)
unzip(temp_zip, exdir = temp_dir)

canada_sf <- st_read(file.path(temp_dir, "lpr_000b16a_e.shp"), quiet = TRUE)

# ---- Keep only provinces (exclude territories) ----
canada_provinces <- canada_sf %>%
  filter(PRUID %in% c("10", "11", "12", "13", "24", "35", "46", "47", "48", "59"))

# ---- Merge data (Quebec left without data) ----
canada_map <- canada_provinces %>%
  left_join(province_data, by = "PRENAME")

# ---- Use st_point_on_surface() for reliable label positions ----
points_inside <- st_point_on_surface(canada_map)
coords_inside <- st_coordinates(points_inside) %>% as.data.frame()
canada_map <- cbind(canada_map, coords_inside)

# ---- Adjust labels for Maritimes ----
canada_map <- canada_map %>%
  mutate(
    label_x = case_when(
      province == "PEI" ~ X + 0.5,
      province == "NS"  ~ X,
      province == "NB"  ~ X + 0.5,
      province == "NL"  ~ X - 4.5,
      TRUE ~ X
    ),
    label_y = case_when(
      province == "PEI" ~ Y + 0.5,
      province == "NS"  ~ Y - 1.5,
      province == "NB"  ~ Y + 0.3,
      province == "NL"  ~ Y - 5.0,
      TRUE ~ Y
    ),
    # Only keep labels for provinces that have data
    label_text = ifelse(province %in% province_data$province, 
                        paste0(province, "\n", percentage, "%"), "")
  )

# ---- Define color scale ----
color_scale <- c(
  "0-4.9" = "#00FF00",
  "5-6.9" = "#66CC66",
  "7-8.9" = "#99DD99",
  "9-10.9" = "#D8BFD8",
  "13-14.9" = "#C8A8D8",
  "15-16.9" = "#B892C8",
  "21-22.9" = "#A87CB8"
)

# ---- Create the map ----
canada_plot <- ggplot(canada_map) +
  geom_sf(aes(fill = category), color = "white", size = 0.5) +
  scale_fill_manual(
    values = color_scale,
    na.value = "grey90",  # Quebec and missing provinces appear grey
    name = "Chronic Use (%)",
    labels = c("0-4.9", "5-6.9 (SK, BC)", "7-8.9 (ON, PEI)", 
               "9-10.9 (AB, MB)", "13-14.9 (NS)", "15-16.9 (NL)", 
               "21-22.9 (NB)"),
    drop = FALSE
  ) +
  geom_text(aes(x = label_x, y = label_y, label = label_text),
            size = 3.5, fontface = "bold", color = "black") +
  labs(
    title = "Chronic Use of 'Sleeping Pills' in Canada",
    subtitle = "2020/21: ≥65 y.o. sedative-hypnotic chronic use (%)",
    caption = "Source: CIHI, Overuse of Tests and Treatments in Canada Nov 2022"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    plot.caption = element_text(hjust = 0.5, size = 9, color = "grey50"),
    legend.position = "right",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 9),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank()
  )

# ---- Save the map ----
save_dir <- file.path(output_dir)
if (!dir.exists(save_dir)) dir.create(save_dir)

ggsave(
  filename = file.path(save_dir, "canada_sleeping_pills_heatmap_FINISH.png"),
  plot = canada_plot,
  width = 14,
  height = 10,
  dpi = 300
)

# ---- Clean up temporary files ----
unlink(temp_zip)
unlink(file.path(temp_dir, "lpr_000b16a_e.*"))
```


## Health Region Data

```{r}
#| label: Health Region Maps - Any Use & Chronic Use

library(sf)
library(dplyr)
library(ggplot2)
library(ragg)

# --- Compute centroids for labels ---
hr_map_data <- hr_map_data %>%
  st_transform(crs = 4326) %>%   # make sure projection is consistent
  mutate(centroid = st_centroid(geometry)) %>%
  cbind(st_coordinates(st_centroid(hr_map_data$geometry))) %>%
  rename(X = X, Y = Y)

# --- Plot function ---
plot_hr_map <- function(data, fill_column, title_text, file_name) {
  
  gg <- ggplot(data) +
    geom_sf(aes_string(fill = fill_column), color = "white", linewidth = 0.5) +
    
    # Add white background labels
    geom_label(
      aes(x = X, y = Y, label = paste0(round(.data[[fill_column]], 1), "%")),
      color = "black",
      fill = "white",
      size = 4,
      fontface = "bold",
      label.padding = unit(0.15, "lines"),
      label.size = 0
    ) +
    
    scale_fill_gradient(
      low = "#e6d3fa", high = "#3f007d", 
      limits = c(SCALE_MIN, SCALE_MAX),
      na.value = "grey90"
    ) +
    
    labs(
      title = title_text,
      caption = "Note: BSHs include BZRAs (benzodiazepines and z-drugs), trazodone, and low-dose quetiapine"
    ) +
    
    theme_void() +             # remove axes and gridlines
    coord_sf(datum = NA) +     # remove longitude/latitude lines
    theme(
      legend.position = "right",
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      plot.caption = element_text(hjust = 0.5, size = 10, margin = margin(t = 10))
    )
  
  # Save as PNG
  ragg::agg_png(file.path(output_dir, file_name), width = 4000, height = 3200, res = 700)
  print(gg)
  dev.off()
  
  return(gg)
}

# --- Example usage ---
map_any_use <- plot_hr_map(hr_map_data, "Any_Use_Perc", "Any BSH Use by Health Region (%)", "HR_Map_Any_Use.png")
map_chronic_use <- plot_hr_map(hr_map_data, "Chronic_Use_Perc", "Chronic BSH Use by Health Region (%)", "HR_Map_Chronic_Use.png")
```

## HR x Sex

```{r}
#| label: Health Region Data by Sex

# ----------------------------------------------------------
# LOAD PACKAGES
# ----------------------------------------------------------
library(dplyr)
library(sf)
library(ggplot2)
library(ragg)

# ----------------------------------------------------------
# Prepare Men and Women datasets (percentages already in 0–100 range)
# ----------------------------------------------------------
# Men summary by Health Region
hr_men <- HR_Sex %>%
  group_by(M_Health_Region) %>%
  summarise(
    Any_Use_Perc = mean(M_Any_Use_Perc, na.rm = TRUE),
    Chronic_Use_Perc = mean(M_Chronic_Use_Perc, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rename(region = M_Health_Region)

# Women summary by Health Region
hr_women <- HR_Sex %>%
  group_by(W_Health_Region) %>%
  summarise(
    Any_Use_Perc = mean(W_Any_Use_Perc, na.rm = TRUE),
    Chronic_Use_Perc = mean(W_Chronic_Use_Perc, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rename(region = W_Health_Region)

# ----------------------------------------------------------
# Join to spatial data
# ----------------------------------------------------------
# Ensure region is numeric for join
health_regions <- health_regions %>% mutate(region = as.numeric(region))

# --- Men map ---
hr_men_map <- health_regions %>%
  left_join(hr_men, by = "region") %>%
  st_as_sf() %>%
  st_transform(crs = 4326)

# Compute centroids for labels
hr_men_centroids <- st_centroid(hr_men_map$geometry) %>% 
  st_coordinates() %>% 
  as.data.frame()
hr_men_map <- cbind(hr_men_map, hr_men_centroids) %>% rename(X = X, Y = Y)

# --- Women map ---
hr_women_map <- health_regions %>%
  left_join(hr_women, by = "region") %>%
  st_as_sf() %>%
  st_transform(crs = 4326)

hr_women_centroids <- st_centroid(hr_women_map$geometry) %>% 
  st_coordinates() %>% 
  as.data.frame()
hr_women_map <- cbind(hr_women_map, hr_women_centroids) %>% rename(X = X, Y = Y)

# ----------------------------------------------------------
# Plot function
# ----------------------------------------------------------
plot_hr_sex_map <- function(data, fill_column, title_text, file_name) {
  
  gg <- ggplot(data) +
    geom_sf(aes_string(fill = fill_column), color = "white", linewidth = 0.5) +
    
    # Labels with white background and one decimal place
    geom_label(
      aes(x = X, y = Y, label = paste0(round(.data[[fill_column]], 1), "%")),
      color = "black",
      fill = "white",
      size = 4,
      fontface = "bold",
      label.padding = unit(0.15, "lines"),
      label.size = 0
    ) +
    
    scale_fill_gradient(
      low = "#e6d3fa", high = "#3f007d", 
      limits = c(SCALE_MIN, SCALE_MAX),
      na.value = "grey90"
    ) +
    
    labs(
      title = title_text,
      caption = "Note: BSHs include BZRAs (benzodiazepines and z-drugs), trazodone, and low-dose quetiapine"
    ) +
    
    theme_void() +
    coord_sf(datum = NA) +  # removes lat/long lines
    theme(
      legend.position = "right",
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      plot.caption = element_text(hjust = 0.5, size = 10, margin = margin(t = 10))
    )
  
  # Export high-res PNG
  ragg::agg_png(file.path(output_dir, file_name), width = 4000, height = 3200, res = 700)
  print(gg)
  dev.off()
  
  return(gg)
}

# ----------------------------------------------------------
# Generate maps
# ----------------------------------------------------------
map_men_any <- plot_hr_sex_map(
  hr_men_map, 
  "Any_Use_Perc", 
  "Any BSH Use by Health Region - Men (%)", 
  "HR_Map_Men_Any_Use.png"
)

map_men_chronic <- plot_hr_sex_map(
  hr_men_map, 
  "Chronic_Use_Perc", 
  "Chronic BSH Use by Health Region - Men (%)", 
  "HR_Map_Men_Chronic_Use.png"
)

map_women_any <- plot_hr_sex_map(
  hr_women_map, 
  "Any_Use_Perc", 
  "Any BSH Use by Health Region - Women (%)", 
  "HR_Map_Women_Any_Use.png"
)

map_women_chronic <- plot_hr_sex_map(
  hr_women_map, 
  "Chronic_Use_Perc", 
  "Chronic BSH Use by Health Region - Women (%)", 
  "HR_Map_Women_Chronic_Use.png"
)
```

## HR x Age Group

```{r}
# ----------------------------------------------------------
# LOAD PACKAGES
# ----------------------------------------------------------
library(dplyr)
library(sf)
library(ggplot2)
library(ragg)
library(tidyr)

# ----------------------------------------------------------
# LOAD SHAPEFILE - Health Regions (7 zones)
# ----------------------------------------------------------
health_regions <- st_read(
  "https://gnb.socrata.com/api/geospatial/x8mg-22ju?method=export&format=GeoJSON",
  quiet = TRUE
) %>%
  st_make_valid() %>%
  st_transform(crs = 4326) %>%
  mutate(region = as.numeric(region))  # numeric for join

# ----------------------------------------------------------
# PREPARE LONG DATA
# ----------------------------------------------------------
hr_long <- HR_AgeGroup %>%
  select(M_HR, M_Age_Group, M_Chronic_Use_Perc,
         W_HR, W_Age_Group, W_Chronic_Use_Perc) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("Sex", ".value"),
    names_pattern = "(M|W)_(.*)"
  ) %>%
  rename(Health_Region = HR,
         Age_Group = Age_Group,
         Chronic_Use_Perc = Chronic_Use_Perc) %>%
  mutate(Sex = ifelse(Sex == "M", "Men", "Women"))

# ----------------------------------------------------------
# JOIN DATA TO SHAPEFILE
# ----------------------------------------------------------
hr_long_sf <- hr_long %>%
  left_join(health_regions, by = c("Health_Region" = "region")) %>%
  st_as_sf() %>%
  st_transform(crs = 4326)

# Compute centroids for labels
hr_long_sf <- hr_long_sf %>%
  mutate(centroid = st_centroid(geometry)) %>%
  cbind(st_coordinates(.$centroid)) %>%
  rename(X = X, Y = Y)

# ----------------------------------------------------------
# PLOT FUNCTION
# ----------------------------------------------------------
plot_hr_map <- function(data, title_text, file_name) {
  
  gg <- ggplot(data) +
    geom_sf(aes(fill = Chronic_Use_Perc), color = "white", linewidth = 0.5) +
    
    geom_label(
      aes(x = X, y = Y, label = paste0(round(Chronic_Use_Perc, 1), "%")),
      fill = "white",
      color = "black",
      fontface = "bold",
      size = 4,
      label.padding = unit(0.15, "lines"),
      label.size = 0
    ) +
    
    scale_fill_gradient(
      low = "#e6d3fa", high = "#3f007d", 
      limits = c(SCALE_MIN, SCALE_MAX),
      na.value = "grey90"
    ) +
    
    labs(
      title = title_text,
      caption = "Note: BSHs include BZRAs (benzodiazepines and z-drugs), trazodone, and low-dose quetiapine"
    ) +
    
    theme_void() +
    coord_sf(datum = NA) +
    theme(
      legend.position = "right",
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      plot.caption = element_text(hjust = 0.5, size = 10, margin = margin(t = 10))
    )
  
  ragg::agg_png(file.path(output_dir, file_name), width = 4000, height = 3200, res = 700)
  print(gg)
  dev.off()
  
  return(gg)
}

# ----------------------------------------------------------
# LOOP TO CREATE 10 MAPS
# ----------------------------------------------------------
age_groups <- c("65-69","70-74","75-79","80-84","85+")
sexes <- c("Men","Women")

for(s in sexes) {
  for(a in age_groups) {
    df_plot <- hr_long_sf %>% filter(Sex == s, Age_Group == a)
    
    map_title <- paste(s, a, "Chronic BSH Use by Health Region (%)")
    file_name <- paste0("HR_Map_", s, "_", gsub("-", "_", a), "_Chronic.png")
    
    plot_hr_map(df_plot, map_title, file_name)
    message("✅ Saved: ", file_name)
  }
}
```